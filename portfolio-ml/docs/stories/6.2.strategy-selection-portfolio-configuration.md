# <!-- Powered by BMADâ„¢ Core -->

# Story 6.2: Strategy Selection and Portfolio Configuration

## Status
Draft

## Story
**As a** portfolio manager,
**I want** an intuitive interface to select AI strategies and configure portfolio parameters,
**so that** I can easily create custom portfolios aligned with my investment objectives and risk tolerance.

## Acceptance Criteria

1. **Strategy Selection Interface**: Clear presentation of GAT, HRP, and LSTM strategies with performance metrics, risk levels, and use case descriptions
2. **Visual Strategy Comparison**: Side-by-side comparison of strategy characteristics including expected returns, volatility, and historical performance
3. **Portfolio Configuration**: User-friendly controls for investment amount, risk preferences, position limits, and rebalancing frequency
4. **Constraint Management**: Intuitive sliders and inputs for maximum position size, sector limits, turnover constraints, and universe selection
5. **Expected Outcomes Prediction**: Real-time calculation and display of expected returns, risk metrics, and portfolio characteristics based on user selections
6. **Configuration Validation**: Input validation with helpful error messages and recommendations for optimal parameter combinations

## Tasks / Subtasks

- [ ] Task 1: Strategy Selection Interface (AC: 1, 2)
  - [ ] Subtask 1.1: Create strategy cards with performance metrics and visual appeal
  - [ ] Subtask 1.2: Implement strategy comparison table with key differentiators
  - [ ] Subtask 1.3: Add strategy descriptions optimized for non-technical users
  - [ ] Subtask 1.4: Build interactive strategy selector with visual feedback
  
- [ ] Task 2: Portfolio Configuration Controls (AC: 3, 4)
  - [ ] Subtask 2.1: Create investment amount input with minimum validation
  - [ ] Subtask 2.2: Build risk preference sliders with visual indicators
  - [ ] Subtask 2.3: Implement constraint configuration with real-time feedback
  - [ ] Subtask 2.4: Add universe selection with asset count and description
  
- [ ] Task 3: Expected Outcomes Calculator (AC: 5)
  - [ ] Subtask 3.1: Integrate with existing model performance data for predictions
  - [ ] Subtask 3.2: Build real-time calculation engine for expected metrics
  - [ ] Subtask 3.3: Create visual display of expected outcomes with confidence intervals
  - [ ] Subtask 3.4: Add comparison with baseline strategies for context
  
- [ ] Task 4: Validation and User Experience (AC: 6)
  - [ ] Subtask 4.1: Implement comprehensive input validation with helpful messages
  - [ ] Subtask 4.2: Add intelligent parameter recommendations based on selections
  - [ ] Subtask 4.3: Create configuration summary with review before portfolio creation
  - [ ] Subtask 4.4: Build portfolio creation workflow with progress indicators

## Dev Notes

### Integration with Existing Model Framework

**Model Configuration Integration:**
- **GAT Configuration**: Load parameters from `configs/models/gat_default.yaml`
- **HRP Configuration**: Use settings from `configs/models/hrp_default.yaml`  
- **LSTM Configuration**: Integrate with `configs/models/lstm_default.yaml`
- **Baseline Models**: Include equal-weight and market cap weighted options

**Performance Data Sources:**
- **Historical Performance**: Use backtest results from existing `results/*_results.json` files
- **Risk Metrics**: Calculate from existing performance analytics framework
- **Expected Returns**: Base predictions on historical model performance with confidence intervals
- **Benchmark Comparisons**: Use existing baseline model results for context

### Strategy Presentation Framework

**User-Friendly Strategy Descriptions:**
```python
# Strategy metadata for user presentation
STRATEGY_PROFILES = {
    "GAT": {
        "display_name": "ðŸŒŸ Graph Neural Network (Premium)",
        "description": "AI learns complex relationships between stocks",
        "best_for": "$1M+ portfolios, institutional investors", 
        "risk_level": 3,  # 1-10 scale
        "expected_return": "12.3% - 13.8%",
        "volatility": "9.8% - 11.2%",
        "key_benefits": ["Highest returns", "Adaptive to market conditions", "Risk-adjusted performance"]
    },
    "HRP": {
        "display_name": "ðŸ’¡ Risk Parity (Balanced)",
        "description": "Smart diversification across sectors",
        "best_for": "Conservative investors, pension funds",
        "risk_level": 2,
        "expected_return": "11.1% - 12.7%", 
        "volatility": "8.9% - 10.8%",
        "key_benefits": ["Lower volatility", "Steady growth", "Excellent diversification"]
    }
    # ... etc
}
```

**Portfolio Constraint Templates:**
```python
# Pre-configured constraint sets for different user types
CONSTRAINT_TEMPLATES = {
    "Conservative": {
        "max_position_weight": 0.10,
        "max_monthly_turnover": 0.15,
        "top_k_positions": 60,
        "sector_max_weight": 0.25
    },
    "Balanced": {
        "max_position_weight": 0.15,
        "max_monthly_turnover": 0.20,
        "top_k_positions": 50,
        "sector_max_weight": 0.30
    }
    # ... etc
}
```

### Expected Outcomes Calculation Engine

**Real-Time Prediction Framework:**
```python
# Expected outcomes calculator using historical data
class PortfolioOutcomesCalculator:
    def __init__(self, historical_results):
        self.results = historical_results
    
    def calculate_expected_outcomes(self, strategy, constraints, investment_amount):
        """Calculate expected portfolio outcomes based on historical performance"""
        base_performance = self.results[strategy]
        
        # Adjust for constraint modifications
        adjusted_return = self.adjust_for_constraints(base_performance, constraints)
        
        # Calculate confidence intervals
        confidence_bands = self.calculate_confidence_intervals(adjusted_return)
        
        return {
            "expected_return": adjusted_return["annual_return"],
            "expected_volatility": adjusted_return["volatility"],
            "expected_sharpe": adjusted_return["sharpe_ratio"],
            "confidence_intervals": confidence_bands,
            "num_holdings": self.estimate_holdings(constraints),
            "expected_turnover": adjusted_return["monthly_turnover"]
        }
```

### User Interface Architecture

**Component Structure:**
```
components/strategy_selection/
â”œâ”€â”€ strategy_cards.py           # Visual strategy presentation
â”œâ”€â”€ comparison_table.py         # Side-by-side comparison
â”œâ”€â”€ configuration_panel.py      # Parameter configuration
â”œâ”€â”€ outcomes_calculator.py      # Expected results display
â”œâ”€â”€ validation_handler.py       # Input validation
â””â”€â”€ portfolio_creator.py        # Creation workflow
```

**State Management:**
- User selections stored in Streamlit session state
- Real-time updates to expected outcomes
- Configuration validation status tracking
- Progress through creation workflow

### Integration with Existing Constraint System

**Constraint Integration:**
- **PortfolioConstraints Class**: Use existing `src/models/base/constraints.py`
- **Validation Logic**: Leverage existing constraint validation methods
- **User-Friendly Mapping**: Convert technical constraints to user-friendly language
- **Real-Time Feedback**: Show constraint impact on expected performance

**Configuration Persistence:**
```python
# Save user configuration for portfolio creation
def save_portfolio_config(user_selections):
    """Save configuration for use by model training/backtesting"""
    config = {
        "strategy": user_selections["strategy"],
        "constraints": user_selections["constraints"],
        "universe": user_selections["universe"],
        "investment_amount": user_selections["amount"],
        "creation_date": datetime.now(),
        "user_preferences": user_selections["preferences"]
    }
    
    # Save to file system for later use
    with open(f"configs/portfolios/portfolio_{timestamp}.yaml", 'w') as f:
        yaml.dump(config, f)
```

### Validation and Error Handling

**Input Validation Framework:**
```python
class ConfigurationValidator:
    def validate_investment_amount(self, amount):
        if amount < 100000:
            return False, "Minimum investment: $100,000"
        return True, ""
    
    def validate_constraints(self, constraints):
        # Check constraint compatibility
        # Provide recommendations for optimization
        # Warn about potential performance impacts
        pass
    
    def recommend_optimizations(self, config):
        # Intelligent suggestions based on configuration
        recommendations = []
        if config["max_position"] > 0.20:
            recommendations.append("Consider reducing max position size for better diversification")
        return recommendations
```

## Testing

### Testing Strategy

**Component Testing:**
- Strategy card rendering with different performance data
- Configuration panel functionality with edge cases
- Expected outcomes calculator accuracy
- Validation logic comprehensive testing

**Integration Testing:**  
- End-to-end portfolio creation workflow
- Integration with existing model configuration system
- File system configuration persistence
- Error handling and user feedback

**User Experience Testing:**
- Usability testing with target user personas
- Configuration workflow efficiency
- Clear error messages and guidance
- Mobile responsiveness for strategy selection

**Test Coverage:**
```
tests/frontend/strategy_selection/
â”œâ”€â”€ test_strategy_cards.py
â”œâ”€â”€ test_configuration_panel.py  
â”œâ”€â”€ test_outcomes_calculator.py
â”œâ”€â”€ test_validation.py
â””â”€â”€ test_integration_workflow.py
```

### Performance Requirements

**Response Times:**
- Strategy comparison loading: <2 seconds
- Real-time outcomes calculation: <500ms
- Configuration validation: <200ms
- Portfolio creation submission: <5 seconds

**Data Accuracy:**
- Expected outcomes within 5% of actual backtest results
- Constraint validation 100% accurate
- Configuration persistence without data loss

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-14 | 1.0 | Initial story creation for strategy selection interface | James (Full Stack Developer) |

## Dev Agent Record

### Agent Model Used
[To be filled during implementation]

### Completion Notes
[To be filled during implementation]

### File List
[To be filled during implementation]

### Change Log
[To be filled during implementation]

### Debug Log References
[To be filled during implementation]