# <!-- Powered by BMAD™ Core -->

# Story 1.4: Basic Portfolio Construction Framework

## Status
✅ **COMPLETED** - Implementation finished and committed

## Story
**As a** portfolio manager,
**I want** equal-weight baseline portfolio implementation with constraint system,
**so that** I have immediate working portfolio functionality and ML comparison baseline.

## Acceptance Criteria

1. Equal-weight allocation function distributes capital across top-k securities (k ∈ {20, 30, 50, 75, 100})
2. Long-only constraint enforcement prevents short positions
3. Monthly rebalancing logic maintains target weights within turnover limits
4. Linear transaction cost model (0.1% per trade) integrated into portfolio performance calculations
5. Basic performance metrics calculated: total return, volatility, Sharpe ratio, maximum drawdown
6. Portfolio position export functionality for analysis and verification

## Tasks / Subtasks

- [x] Task 1: Implement Equal-Weight Allocation Engine (AC: 1)
  - [x] Subtask 1.1: Create `src/models/baselines/equal_weight.py` module with EqualWeightModel class
  - [x] Subtask 1.2: Implement top-k security selection logic with configurable k values
  - [x] Subtask 1.3: Add equal-weight distribution function ensuring weights sum to 1.0
  - [x] Subtask 1.4: Integrate with existing UniverseCalendar from Story 1.2 for dynamic universe handling

- [x] Task 2: Implement Unified Constraint System (AC: 2, 3)
  - [x] Subtask 2.1: Create `src/models/base/portfolio_model.py` with PortfolioModel abstract base class *(pre-existing)*
  - [x] Subtask 2.2: Create `src/models/base/constraints.py` with PortfolioConstraints dataclass *(pre-existing)*
  - [x] Subtask 2.3: Implement long-only constraint enforcement preventing negative weights
  - [x] Subtask 2.4: Add monthly turnover calculation and enforcement logic
  - [x] Subtask 2.5: Create constraint validation framework for all model types

- [x] Task 3: Build Transaction Cost Integration (AC: 4)
  - [x] Subtask 3.1: Create `src/evaluation/backtest/transaction_costs.py` module
  - [x] Subtask 3.2: Implement linear transaction cost model at 0.1% per trade
  - [x] Subtask 3.3: Add turnover calculation based on weight changes between rebalancing periods
  - [x] Subtask 3.4: Integrate transaction costs into portfolio performance calculations

- [x] Task 4: Implement Basic Performance Analytics (AC: 5)
  - [x] Subtask 4.1: Create `src/evaluation/metrics/returns.py` with core performance functions *(enhanced existing)*
  - [x] Subtask 4.2: Implement Sharpe ratio calculation with annualization
  - [x] Subtask 4.3: Add maximum drawdown calculation with peak-to-trough analysis
  - [x] Subtask 4.4: Create total return and volatility calculations

- [x] Task 5: Build Portfolio Export and Analysis Framework (AC: 6)
  - [x] Subtask 5.1: Create `src/evaluation/reporting/export.py` for position export
  - [x] Subtask 5.2: Implement portfolio weight serialization to parquet format
  - [x] Subtask 5.3: Add monthly rebalancing schedule export functionality
  - [x] Subtask 5.4: Create portfolio analytics dashboard for verification

- [x] Task 6: Integration and Monthly Rebalancing Logic (AC: 3)
  - [x] Subtask 6.1: Create `src/evaluation/backtest/rebalancing.py` module
  - [x] Subtask 6.2: Implement monthly rebalancing scheduler using universe calendar
  - [x] Subtask 6.3: Add rebalancing trade generation and execution logic
  - [x] Subtask 6.4: Integrate with existing parquet data pipeline from Story 1.3

- [x] Task 7: Testing and Validation Framework
  - [x] Subtask 7.1: Create unit tests for equal-weight allocation logic
  - [x] Subtask 7.2: Implement constraint system validation tests
  - [x] Subtask 7.3: Add transaction cost calculation verification tests
  - [x] Subtask 7.4: Create integration tests for end-to-end portfolio construction

## Dev Notes

### Previous Story Insights
From Story 1.3 completion:
- Multi-source data pipeline established with comprehensive gap-filling and quality validation
- High-performance parquet storage with monthly partitioning and optimized I/O
- Dynamic universe calendar alignment from Story 1.2 integration successful
- Complete testing infrastructure with >95% code coverage established
- Data quality scoring framework with automated reporting available
- All data processing components successfully integrated and validated

### Base Portfolio Model Interface
[Source: docs/technical-architecture.md#machine-learning-model-architecture]

**Required Imports:**
```python
from abc import ABC, abstractmethod
from dataclasses import dataclass
from typing import Dict, List, Optional, Tuple
import pandas as pd
import numpy as np
```

**Interface Implementation:**
```python
from abc import ABC, abstractmethod
from dataclasses import dataclass
from typing import Dict, List, Optional, Tuple

@dataclass
class PortfolioConstraints:
    long_only: bool = True                      # No short positions
    top_k_positions: Optional[int] = None       # Maximum number of positions
    max_position_weight: float = 0.10           # Maximum single position
    max_monthly_turnover: float = 0.20          # Turnover limit
    transaction_cost_bps: float = 10.0          # Linear transaction costs

class PortfolioModel(ABC):
    def __init__(self, constraints: PortfolioConstraints):
        self.constraints = constraints

    @abstractmethod
    def fit(self,
            returns: pd.DataFrame,
            universe: List[str],
            fit_period: Tuple[pd.Timestamp, pd.Timestamp]) -> None:
        """Train model on historical data."""

    @abstractmethod
    def predict_weights(self,
                       date: pd.Timestamp,
                       universe: List[str]) -> pd.Series:
        """Generate portfolio weights for rebalancing date."""

    @abstractmethod
    def get_model_info(self) -> Dict[str, Any]:
        """Return model metadata for analysis."""
```

### File Location Guidelines
[Source: docs/technical-architecture.md#repository-structure-and-organization]

**Module Structure:**
- Base portfolio interface: `src/models/base/portfolio_model.py` (NEW - Task 2.1)
- Base constraints: `src/models/base/constraints.py` (NEW - Task 2.2)
- Equal-weight model: `src/models/baselines/equal_weight.py` (NEW - Task 1.1)
- Transaction costs: `src/evaluation/backtest/transaction_costs.py` (NEW - Task 3.1)
- Rebalancing logic: `src/evaluation/backtest/rebalancing.py` (NEW - Task 6.1)
- Performance metrics: `src/evaluation/metrics/returns.py` (NEW - Task 4.1)
- Export functionality: `src/evaluation/reporting/export.py` (NEW - Task 5.1)

### Performance Analytics Requirements
[Source: docs/technical-architecture.md#evaluation-and-backtesting-framework]
```python
class PerformanceAnalytics:
    @staticmethod
    def sharpe_ratio(returns: pd.Series, risk_free_rate: float = 0.0) -> float:
        """Annualized Sharpe ratio with bias correction."""
        excess_returns = returns - risk_free_rate/252  # Daily risk-free rate
        return np.sqrt(252) * excess_returns.mean() / excess_returns.std()

    @staticmethod
    def maximum_drawdown(returns: pd.Series) -> Tuple[float, pd.Timestamp, pd.Timestamp]:
        """Maximum drawdown with start and end dates."""
        cumulative = (1 + returns).cumprod()
        running_max = cumulative.expanding().max()
        drawdown = (cumulative - running_max) / running_max

        max_dd = drawdown.min()
        max_dd_date = drawdown.idxmin()

        # Find start of drawdown period
        prior_peak = running_max.loc[:max_dd_date].idxmax()

        return max_dd, prior_peak, max_dd_date
```

### Universe Integration Requirements
From Story 1.2 established architecture:
- Use `UniverseCalendar` class for dynamic universe management
- Integrate with `get_active_tickers(date)` method for monthly rebalancing
- Handle universe transitions (additions/deletions) during rebalancing periods
- Maintain alignment with existing parquet data pipeline

### Data Pipeline Integration
From Story 1.3 established infrastructure:
- Load price and return data from `data/processed/returns_daily.parquet`
- Use `PortfolioDataLoader` class for efficient data access
- Leverage monthly partitioning for optimized rebalancing calculations
- Integrate with data quality validation framework

### Configuration System Integration
From Story 1.1 established patterns:
```python
@dataclass
class DataConfig:
    universe: str = "midcap400"
    start_date: str = "2016-01-01"
    end_date: str = "2024-12-31"
    sources: list = None

@dataclass
class ModelConfig:
    name: str
    hyperparameters: Dict = field(default_factory=dict)
    training_config: Dict = field(default_factory=dict)
    constraint_config: Dict = field(default_factory=dict)
```

### Technical Constraints
- **GPU Memory**: Not applicable for equal-weight baseline (CPU-only processing)
- **Performance**: Monthly rebalancing must complete within 10 minutes per month
- **Time Period**: Handle 2016-2024 evaluation period with ~400 assets
- **Transaction Costs**: Linear model at 0.1% (10 basis points) per trade
- **Dependencies**: pandas ≥2.0.0, numpy ≥1.24.0, scikit-learn ≥1.3.0

## Testing

### Testing Standards and Framework
Based on established patterns from Stories 1.2 and 1.3:

**Test File Locations:**
- Unit tests: `tests/unit/test_baselines/test_equal_weight.py`, `tests/unit/test_constraints.py`
- Integration tests: `tests/integration/test_portfolio_construction.py`

**Testing Frameworks:**
- pytest ≥7.4.0 with coverage reporting
- pytest-xdist for parallel testing
- Mock/patch for data loading testing
- Sample data fixtures for reproducible testing

**Specific Testing Requirements:**
1. **Equal-Weight Tests**: Test weight distribution accuracy and top-k selection logic
2. **Constraint Tests**: Validate long-only enforcement and turnover calculations
3. **Transaction Cost Tests**: Verify cost calculations and integration with performance metrics
4. **Performance Metrics Tests**: Test Sharpe ratio, drawdown, and return calculations
5. **Integration Tests**: End-to-end portfolio construction with sample S&P MidCap 400 data
6. **Rebalancing Tests**: Monthly rebalancing logic with universe changes

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-07 | 1.0 | Initial story creation with comprehensive architecture context | Bob (Scrum Master) |
| 2025-09-07 | 1.1 | Minor enhancements: Added base portfolio interface creation task, explicit import dependencies, updated file structure clarity | Sarah (Product Owner) |

## Dev Agent Record
*Implementation completed by Claude-3.5-Sonnet development agent*

### Agent Model Used
claude-sonnet-4-20250514

### Debug Log References
- Fixed JSON serialization issues in portfolio export functionality
- Updated pandas frequency parameter from deprecated 'M' to 'ME'
- Resolved constraint engine edge cases for empty portfolios
- Fixed type annotation modernization with ruff linting

### Completion Notes
- **All 7 Tasks Completed**: Equal-weight allocation engine, constraint system integration, transaction cost modeling, performance analytics, export framework, monthly rebalancing, and comprehensive testing
- **Test Coverage**: 44 unit tests and integration tests covering all major components
- **Code Quality**: All code passes ruff linting with modern type annotations
- **Integration Validated**: End-to-end portfolio construction workflow tested and verified
- **Performance Requirements Met**: Monthly rebalancing processes within acceptable timeframes

### File List
**New Implementation Files:**
- `src/models/baselines/equal_weight.py` - EqualWeightModel implementation
- `src/evaluation/backtest/transaction_costs.py` - Transaction cost modeling
- `src/evaluation/backtest/rebalancing.py` - Monthly rebalancing engine
- `src/evaluation/reporting/export.py` - Portfolio export and analytics framework

**Enhanced Existing Files:**
- `src/evaluation/metrics/returns.py` - Added comprehensive performance analytics (Sharpe ratio, max drawdown, etc.)
- `src/models/base/portfolio_model.py` - Already implemented (pre-existing)
- `src/models/base/constraints.py` - Already implemented with edge case fixes

**Test Files:**
- `tests/unit/test_baselines/test_equal_weight.py` - EqualWeightModel unit tests (15 tests)
- `tests/unit/test_constraints.py` - Constraint system unit tests (15 tests)
- `tests/unit/test_transaction_costs.py` - Transaction cost unit tests (14 tests)
- `tests/integration/test_portfolio_construction.py` - End-to-end integration tests

## QA Results
*To be filled by QA Agent after story completion*
