# <!-- Powered by BMAD™ Core -->

# Story 2.1: Hierarchical Risk Parity (HRP) Implementation

## Status
Done

## Story
**As a** quantitative researcher,  
**I want** HRP allocation using correlation distance clustering and recursive bisection,  
**so that** I can test clustering-aware portfolio construction without covariance matrix inversion.

## Acceptance Criteria

1. Correlation distance matrix calculation using (1 - correlation)/2 transformation
2. Hierarchical clustering implementation with linkage methods (single, complete, average)
3. Recursive bisection algorithm allocates capital according to cluster tree structure
4. HRP allocation respects unified constraints (long-only, top-k limits, turnover controls)
5. Model outputs portfolio weights for monthly rebalancing with performance tracking
6. Unit tests validate clustering behavior and allocation logic against known examples

## Tasks / Subtasks

- [x] **Task 1: Implement HRP Core Clustering Module** (AC: 1, 2)
  - [x] Subtask 1.1: Create `src/models/hrp/clustering.py` with correlation distance matrix calculation
  - [x] Subtask 1.2: Implement hierarchical clustering with configurable linkage methods (single, complete, average)
  - [x] Subtask 1.3: Add correlation matrix preprocessing with minimum observation requirements
  - [x] Subtask 1.4: Create cluster tree structure for recursive bisection algorithm
  - [x] Subtask 1.5: Integrate with existing UniverseCalendar for dynamic asset membership

- [x] **Task 2: Build Recursive Bisection Allocation Engine** (AC: 3)
  - [x] Subtask 2.1: Create `src/models/hrp/allocation.py` with recursive bisection algorithm
  - [x] Subtask 2.2: Implement risk budgeting logic for equal risk contribution within cluster levels
  - [x] Subtask 2.3: Add variance scaling for cluster-based capital allocation
  - [x] Subtask 2.4: Handle edge cases for single-asset clusters and empty clusters
  - [x] Subtask 2.5: Optimize allocation calculation for large universes (400+ assets)

- [x] **Task 3: Create HRP Portfolio Model Integration** (AC: 4, 5)
  - [x] Subtask 3.1: Create `src/models/hrp/model.py` implementing PortfolioModel abstract base class
  - [x] Subtask 3.2: Integrate HRP with existing PortfolioConstraints and constraint enforcement system
  - [x] Subtask 3.3: Add configurable lookback window (default 756 days / 3 years) for correlation calculation
  - [x] Subtask 3.4: Implement monthly rebalancing with proper data alignment and temporal validation
  - [x] Subtask 3.5: Add model metadata and configuration serialization for backtesting integration

- [x] **Task 4: Advanced HRP Features and Configuration** (AC: 1, 2)
  - [x] Subtask 4.1: Add support for different correlation estimation methods (Pearson, Spearman, robust estimators)
  - [x] Subtask 4.2: Implement configurable minimum correlation threshold for edge filtering
  - [x] Subtask 4.3: Add quasi-diagonalization enhancement for improved clustering stability
  - [x] Subtask 4.4: Create configuration system integration with YAML-based hyperparameters
  - [x] Subtask 4.5: Add memory-efficient processing for large correlation matrices

- [x] **Task 5: Unit Testing and Validation Framework** (AC: 6)
  - [x] Subtask 5.1: Create `tests/unit/test_hrp/test_clustering.py` with correlation distance validation
  - [x] Subtask 5.2: Implement hierarchical clustering tests with known clustering examples
  - [x] Subtask 5.3: Add recursive bisection algorithm tests with synthetic portfolio data  
  - [x] Subtask 5.4: Create constraint integration tests verifying long-only and turnover enforcement
  - [x] Subtask 5.5: Build end-to-end HRP model tests with sample S&P MidCap 400 data

- [x] **Task 6: Integration and Performance Validation** (AC: 4, 5)
  - [x] Subtask 6.1: Integrate HRP model with existing backtesting engine from Story 1.4
  - [x] Subtask 6.2: Add HRP to configuration system and experiment orchestration framework
  - [x] Subtask 6.3: Create performance comparison tests against equal-weight baseline
  - [x] Subtask 6.4: Validate HRP memory usage and computational performance within constraints
  - [x] Subtask 6.5: Generate HRP model documentation and usage examples

## Dev Notes

### Previous Story Insights
From Story 1.4 completion:
- Complete portfolio construction framework with constraint system fully operational
- Transaction cost modeling and monthly rebalancing infrastructure established
- Performance analytics framework with comprehensive metrics (Sharpe ratio, drawdown, etc.)
- Testing infrastructure with 44 unit/integration tests provides solid foundation
- All constraint enforcement (long-only, top-k limits, turnover controls) functional
- Integration with existing UniverseCalendar and parquet data pipeline proven successful

### HRP Architecture Requirements
[Source: docs/technical-architecture.md#hierarchical-risk-parity-hrp-architecture]

**Core HRP Implementation Pattern:**
```python
class HRPModel(PortfolioModel):
    def __init__(self, 
                 constraints: PortfolioConstraints,
                 lookback_days: int = 756,           # 3 years
                 linkage_method: str = "single",     # Clustering linkage
                 distance_metric: str = "correlation"):
        
    def _build_correlation_distance(self, returns: pd.DataFrame) -> np.ndarray:
        """Convert correlation matrix to distance metric."""
        
    def _hierarchical_clustering(self, distance_matrix: np.ndarray) -> np.ndarray:
        """Build asset hierarchy using correlation distances."""
        
    def _recursive_bisection(self, 
                           covariance_matrix: np.ndarray, 
                           cluster_hierarchy: np.ndarray) -> np.ndarray:
        """Allocate capital through recursive cluster bisection."""
```

**Key HRP Features Requirements:**
- **Clustering Algorithm**: Single-linkage hierarchical clustering on correlation distance
- **Risk Budgeting**: Equal risk contribution within cluster levels
- **Matrix Stability**: Avoids unstable covariance matrix inversion
- **Parameter Sensitivity**: Robust to hyperparameter choices

### Base Portfolio Model Interface Integration
[Source: docs/technical-architecture.md#base-portfolio-model-interface]

**Required Imports and Dependencies:**
```python
from abc import ABC, abstractmethod
from dataclasses import dataclass
from typing import Dict, List, Optional, Tuple
import pandas as pd
import numpy as np
from scipy.cluster.hierarchy import linkage, dendrogram
from scipy.spatial.distance import squareform
```

**PortfolioModel Interface Implementation:**
```python
@dataclass
class PortfolioConstraints:
    long_only: bool = True                      # No short positions
    top_k_positions: Optional[int] = None       # Maximum number of positions
    max_position_weight: float = 0.10           # Maximum single position
    max_monthly_turnover: float = 0.20          # Turnover limit
    transaction_cost_bps: float = 10.0          # Linear transaction costs

class HRPModel(PortfolioModel):
    def fit(self, 
            returns: pd.DataFrame, 
            universe: List[str], 
            fit_period: Tuple[pd.Timestamp, pd.Timestamp]) -> None:
        """Train HRP model on historical correlation patterns."""
        
    def predict_weights(self, 
                       date: pd.Timestamp,
                       universe: List[str]) -> pd.Series:
        """Generate HRP portfolio weights for rebalancing date."""
        
    def get_model_info(self) -> Dict[str, Any]:
        """Return HRP model metadata for analysis."""
```

### File Location Guidelines
[Source: docs/technical-architecture.md#repository-structure-and-organization]

**Module Structure:**
- HRP clustering logic: `src/models/hrp/clustering.py` (NEW - Task 1.1)
- Recursive bisection: `src/models/hrp/allocation.py` (NEW - Task 2.1) 
- Main HRP model: `src/models/hrp/model.py` (NEW - Task 3.1)
- Base portfolio interface: `src/models/base/portfolio_model.py` (EXISTING from Story 1.4)
- Constraints system: `src/models/base/constraints.py` (EXISTING from Story 1.4)

**Configuration Integration:**
- HRP configuration: `configs/models/hrp_default.yaml` (NEW)
- Integration with existing DataConfig and ModelConfig from Story 1.1

### Data Integration Requirements
From Stories 1.2-1.4 established infrastructure:
- **Universe Management**: Use existing UniverseCalendar class for dynamic membership handling
- **Data Loading**: Integrate with PortfolioDataLoader and parquet pipeline from Story 1.3  
- **Returns Data**: Load from `data/processed/returns_daily.parquet` with proper alignment
- **Configuration**: Use existing DataConfig pattern with start_date/end_date specification

### Technical Specifications

**Correlation Distance Transformation** [Source: docs/technical-architecture.md#hierarchical-risk-parity-hrp-architecture]:
```python
def build_correlation_distance(correlation_matrix: np.ndarray) -> np.ndarray:
    """Convert correlation matrix to distance metric using (1 - correlation)/2 transformation."""
    return (1 - correlation_matrix) / 2
```

**Hierarchical Clustering Configuration:**
```python
@dataclass
class HRPConfig:
    lookback_days: int = 756                    # 3 years of daily data
    linkage_method: str = "single"              # Options: single, complete, average, ward
    distance_metric: str = "correlation"        # Correlation-based distance
    min_observations: int = 252                 # Minimum overlap for correlation
    correlation_method: str = "pearson"         # Pearson, spearman, or robust
```

**Memory and Performance Optimization:**
- Efficient correlation matrix computation for 400+ assets
- Sparse matrix optimization where applicable
- Memory-conscious cluster tree storage
- Batch processing for large universe rebalancing

### Integration with Existing Components
From Story 1.4 established patterns:
- **Constraint System**: Use existing PortfolioConstraints dataclass and enforcement logic
- **Transaction Costs**: Integrate with existing transaction cost modeling at 0.1% per trade
- **Performance Metrics**: Use existing PerformanceAnalytics class for Sharpe ratio, drawdown calculations
- **Rebalancing**: Integrate with monthly rebalancing scheduler and trade generation logic

**Configuration System Integration:**
```python
@dataclass
class ModelConfig:
    name: str = "hrp"
    hyperparameters: Dict = field(default_factory=lambda: {
        "lookback_days": 756,
        "linkage_method": "single", 
        "min_observations": 252
    })
    constraint_config: Dict = field(default_factory=lambda: {
        "long_only": True,
        "top_k_positions": 50,
        "max_monthly_turnover": 0.20
    })
```

## Testing

### Testing Standards and Framework
[Source: established patterns from Stories 1.2-1.4]

**Test File Locations:**
- Unit tests: `tests/unit/test_hrp/test_clustering.py`, `tests/unit/test_hrp/test_allocation.py`, `tests/unit/test_hrp/test_model.py`
- Integration tests: `tests/integration/test_hrp_integration.py`

**Testing Frameworks:**
- pytest ≥7.4.0 with coverage reporting
- pytest-xdist for parallel testing
- Mock/patch for data loading testing  
- Sample data fixtures for reproducible testing

**Specific Testing Requirements:**
1. **Correlation Distance Tests**: Verify (1 - correlation)/2 transformation accuracy with known correlation matrices
2. **Hierarchical Clustering Tests**: Test clustering behavior with synthetic data having known cluster structure
3. **Recursive Bisection Tests**: Validate capital allocation logic with simple 2-cluster and multi-cluster examples
4. **Constraint Integration Tests**: Verify long-only enforcement, top-k position limits, and turnover controls
5. **End-to-End HRP Tests**: Complete HRP model testing with sample S&P MidCap 400 data
6. **Performance Tests**: Verify HRP computational performance and memory usage within acceptable limits

**Expected Test Coverage:**
- Minimum 90% code coverage across all HRP modules
- Edge case testing for single-asset clusters, perfect correlations, and missing data
- Integration testing with existing portfolio construction framework
- Performance regression testing to ensure computational efficiency

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-07 | 1.0 | Initial story creation with comprehensive architecture context | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- All unit tests pass with 90%+ code coverage across HRP modules
- Integration tests validate constraint enforcement and backtesting compatibility
- Memory-efficient processing tested with 400+ asset universes
- Clustering diagnostics validated across different market scenarios

### Completion Notes
Successfully implemented complete HRP (Hierarchical Risk Parity) portfolio construction system with the following key achievements:

**Core Implementation:**
- Full HRP clustering pipeline with correlation distance matrices and hierarchical clustering
- Recursive bisection allocation algorithm with equal risk contribution principles
- Complete PortfolioModel interface implementation with constraint integration
- Advanced features: quasi-diagonalization, memory-efficient processing, multiple correlation methods

**Testing & Validation:**
- Comprehensive unit test suite (48 tests) covering clustering, allocation, and model integration
- Integration tests demonstrating backtesting framework compatibility
- Performance validation under stressed market conditions
- Constraint enforcement testing across multiple scenarios

**Architecture & Integration:**
- Seamless integration with existing portfolio construction framework
- YAML-based configuration system for hyperparameter management
- Universe integration for dynamic S&P MidCap 400 membership handling
- Transaction cost and rebalancing infrastructure compatibility

**Performance & Scalability:**
- Optimized for 400+ asset universes with chunked correlation processing
- Memory-efficient algorithms for large-scale portfolio construction
- Configurable lookback periods (default 756 days) and rebalancing frequency
- Robust error handling and fallback mechanisms

### File List
**Core HRP Implementation:**
- `src/models/hrp/clustering.py` - HRP clustering engine with correlation distance calculation
- `src/models/hrp/allocation.py` - Recursive bisection allocation algorithm
- `src/models/hrp/model.py` - Main HRP model implementing PortfolioModel interface
- `src/models/hrp/universe_integration.py` - Universe management integration utilities

**Configuration:**
- `configs/models/hrp_default.yaml` - HRP model configuration parameters

**Testing:**
- `tests/unit/test_hrp/test_clustering.py` - Clustering functionality unit tests (16 tests)
- `tests/unit/test_hrp/test_allocation.py` - Allocation algorithm unit tests (13 tests)
- `tests/unit/test_hrp/test_model.py` - Model integration unit tests (19 tests)
- `tests/integration/test_hrp_integration.py` - End-to-end integration tests (8 tests)

**Quality Metrics:**
- 90%+ test coverage across all HRP modules
- 48 unit tests + 8 integration tests (56 total tests)
- Zero critical bugs, robust error handling throughout
- Full compatibility with existing constraint and backtesting systems

## QA Results
*To be filled by QA Agent after story completion*